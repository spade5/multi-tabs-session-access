{"version":3,"sources":["../lib/index.js","index.ts"],"names":["Object","defineProperty","exports","value","CHANNEL_STORAGE_KEY","SHARED_SESSION_KEY","MSG_TYPE_REQUEST","MSG_TYPE_REPLY","MSG_TYPE_SYNC","TIMEOUT","SharedSession","_this","_ready","changeCallback","ready","Promise","res","setTimeout","getItem","key","then","data","setItem","newData","assign","window","addEventListener","_a","newValue","handleMsg","request","prototype","onChange","callback","msg","msgObj","JSON","parse","type","handleRequest","handleReply","payload","handleSync","e","sendMsg","localStorage","stringify","timeStamp","Date","now","reply","console","log","dataStr","syncData","str","get","sessionStorage","set","enumerable","configurable","_data","removeItem","clear","session","Session","getItemSync","listen","default"],"mappings":"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","file":"example.260ad5c4.js","sourceRoot":"..","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar CHANNEL_STORAGE_KEY = '__channel_storage_key__';\nvar SHARED_SESSION_KEY = '__shared_session_key__';\nvar MSG_TYPE_REQUEST = '__msg_type_request__';\nvar MSG_TYPE_REPLY = '__msg_type_reply__';\nvar MSG_TYPE_SYNC = '__msg_type_sync__';\nvar TIMEOUT = 200;\nvar SharedSession = /** @class */ (function () {\n    function SharedSession() {\n        var _this = this;\n        this._ready = false;\n        this.changeCallback = function () { return null; };\n        this.ready = function () {\n            return new Promise(function (res) {\n                if (_this._ready) {\n                    res();\n                }\n                else {\n                    setTimeout(function () { return res(); }, TIMEOUT);\n                }\n            });\n        };\n        this.getItem = function (key) {\n            return _this.ready().then(function () {\n                return _this.data[key];\n            });\n        };\n        this.setItem = function (key, value) {\n            return _this.ready().then(function () {\n                var newData = Object.assign({}, _this.data);\n                newData[key] = value;\n                _this.data = newData;\n            });\n        };\n        window.addEventListener(\"storage\", function (_a) {\n            var key = _a.key, newValue = _a.newValue;\n            if (key === CHANNEL_STORAGE_KEY) {\n                _this.handleMsg(newValue || '{}');\n            }\n        });\n        this.request(); // 请求连接\n        setTimeout(function () {\n            _this._ready = true;\n        }, TIMEOUT); //200ms 后超时，设置 ready 状态\n    }\n    SharedSession.prototype.onChange = function (callback) {\n        this.changeCallback = callback;\n    };\n    SharedSession.prototype.handleMsg = function (msg) {\n        try {\n            var msgObj = JSON.parse(msg);\n            switch (msgObj.type) {\n                case MSG_TYPE_REQUEST:\n                    this.handleRequest();\n                    break;\n                case MSG_TYPE_REPLY:\n                    this.handleReply(msgObj.payload);\n                    break;\n                case MSG_TYPE_SYNC:\n                    this.handleSync(msgObj.payload);\n                    break;\n            }\n        }\n        catch (e) {\n            throw 'error message format:' + msg;\n        }\n    };\n    SharedSession.prototype.sendMsg = function (msg) {\n        localStorage.setItem(CHANNEL_STORAGE_KEY, JSON.stringify(Object.assign({ timeStamp: Date.now() }, msg)));\n    };\n    SharedSession.prototype.request = function () {\n        this.sendMsg({\n            type: MSG_TYPE_REQUEST,\n        });\n    };\n    SharedSession.prototype.reply = function () {\n        console.log('reply');\n        this.sendMsg({\n            type: MSG_TYPE_REPLY,\n            payload: this.dataStr\n        });\n    };\n    SharedSession.prototype.syncData = function () {\n        this.sendMsg({\n            type: MSG_TYPE_SYNC,\n            payload: this.dataStr\n        });\n    };\n    SharedSession.prototype.handleRequest = function () {\n        if (this.dataStr)\n            this.reply();\n    };\n    SharedSession.prototype.handleReply = function (str) {\n        this.dataStr = str || '';\n        this._ready = true;\n    };\n    SharedSession.prototype.handleSync = function (str) {\n        this.dataStr = str || '';\n    };\n    Object.defineProperty(SharedSession.prototype, \"dataStr\", {\n        get: function () {\n            return sessionStorage.getItem(SHARED_SESSION_KEY) || '{}';\n        },\n        set: function (str) {\n            sessionStorage.setItem(SHARED_SESSION_KEY, str || '{}');\n            this.changeCallback(this.data);\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(SharedSession.prototype, \"data\", {\n        get: function () {\n            try {\n                var str = this.dataStr;\n                if (str)\n                    return JSON.parse(str);\n            }\n            catch (e) { }\n            return {};\n        },\n        set: function (_data) {\n            var str = JSON.stringify(_data);\n            this.dataStr = str;\n            this.syncData();\n        },\n        enumerable: false,\n        configurable: true\n    });\n    SharedSession.prototype.removeItem = function (key) {\n        var _this = this;\n        return this.ready().then(function () {\n            var newData = Object.assign({}, _this.data);\n            delete newData[key];\n            _this.data = newData;\n        });\n    };\n    SharedSession.prototype.clear = function () {\n        var _this = this;\n        return this.ready().then(function () {\n            sessionStorage.removeItem(SHARED_SESSION_KEY);\n            _this.syncData();\n        });\n    };\n    return SharedSession;\n}());\nvar session = new SharedSession();\nvar Session = {\n    ready: function () {\n        return session.ready();\n    },\n    getItemSync: function (key) {\n        return session.data && session.data[key];\n    },\n    getItem: function (key) {\n        return session.getItem(key);\n    },\n    setItem: function (key, value) {\n        return session.setItem(key, value);\n    },\n    removeItem: function (key) {\n        return session.removeItem(key);\n    },\n    clear: function () {\n        return session.clear();\n    },\n    listen: function (callback) {\n        session.onChange(callback);\n    }\n};\nexports.default = Session;\n","import SharedSession from '../lib/index'\nimport './index.css'\n\nconst countSpan = document.getElementById('count')\nconst btn = document.getElementById('btn')\n\nlet count = 0\n\nbtn && btn.addEventListener('click', () => {\n  count++\n  SharedSession.setItem('count', count + '')\n})\n\nSharedSession.listen(() => {\n  SharedSession.getItem('count').then((value) => {\n    if (value) {\n      count = +value\n      changeValue()\n    }\n  })\n})\n\nSharedSession.getItem('count').then((value) => {\n  if (value) {\n    count = +value\n    changeValue()\n  }\n})\n\nfunction changeValue() {\n  countSpan && (countSpan.innerText = count + '')\n}"]}